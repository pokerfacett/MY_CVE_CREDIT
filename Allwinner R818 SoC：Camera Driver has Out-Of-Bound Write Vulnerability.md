## Background
Allwinner R818 SoC is made for smart speakers with a screen which is a processor for use in Android-based
It integrates quad-core 64-bit CortexTM-A53 CPU and Imagination PowerVR GE8300 GPU to ensure response rapidity and
running smoothness for daily application, such as on-line video, web browsing, and so on

## Description
There is a Out-of-Bount Write in the camera driver "/dev/cedar_dev". An third-app could cause a system crash or EoP.

## Affect Versions
Soc: Allwinner R818 

System: R818 Android Q 

SDK Version: V1.0 

## POC

### Implementation defect 1: IOCTL_SET_PROC_INFO

![image](https://user-images.githubusercontent.com/13774458/129026059-d045299b-4640-4c7d-9cc5-7a1a3ff00f69.png)

You can see that the data copied from the user mode is ve_info, which is defined as follows:

![image](https://user-images.githubusercontent.com/13774458/129026124-30b0fa3d-c716-4a87-ae81-bdcb2bef4878.png)


Therefore, the user mode can pass in a channel_id and proc_info_len
The implementation problem here is that it only judges whether the channel_id is legal, but does not judge the proc_info_len, so the maximum proc_info_len is 0xFFFFFFFF (64 bits). Of course, it will not trigger a crash.

### Implementation defect 1: IOCTL_COPY_PROC_INFO

What really triggers the security problem is the following part:

![image](https://user-images.githubusercontent.com/13774458/129026261-c89c4afa-8065-4e92-8ea4-190ae31cd280.png)

It can be seen that ve_debug_proc_info.proc_len[channel_id] is the proc_info_len we controlled above (maximum is 0xFFFFFFFF (64 bits)). The length check is not performed here and it is directly copied to proc_buf, and arg is controllable in user mode, which will cause Write out of bounds, and the size of proc_buf

![image](https://user-images.githubusercontent.com/13774458/129026337-a5ed5ae9-1fa4-4456-be5d-74759eba5646.png)


which will cause OOB Write


## Patch

Allwinner will update the corresponding patch on the corresponding chip

![image](https://user-images.githubusercontent.com/13774458/129026429-322504ec-b03d-4731-9c21-3f4f4d184c52.png)

## Reporter

Lewei Qu and Dongxiang Ke


## References
https://www.cnvd.org.cn/flaw/show/CNVD-2021-49168

https://vul.wangan.com/a/CNVD-2021-49168

https://www.allwinnertech.com/index.php?c=product&a=index&id=92
